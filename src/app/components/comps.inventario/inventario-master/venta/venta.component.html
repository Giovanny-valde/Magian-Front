<div class="tcard">
  <div class="tcard-title">
    <div class="row align-items-center">
      <div class="col-md-7 text-center">
        <i class="mx-3 fa-shopping-cart fa-solid"></i>
        <span> Lista de Ventas</span>
      </div>
      <div class="col-md-5 text-end">
        <button type="button" class="btn btn-sm btn-crear" data-bs-toggle="modal" data-bs-target="#ventaModalAgregar" (click)="verDatos('none',3)">
          <i class="fas fa-plus"></i>
          Añadir Venta
        </button>
      </div>
    </div>
  </div>
  <div class="tcard-content">
    <table id="seTable" datatable [dtOptions]="dtOptions" class="table table-striped"
      style="background-color: #f5f5f5;border: 1px solid #e0e0e0;">
      <thead class="text-center">
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Precio</th>
          <th>Fecha de compra</th>
          <th>Total</th>
          <th>Opciones</th>
        </tr>
      </thead>
      <tbody>
        <tr class="text-center" *ngFor="let ventas of personaInventarios$ | async">
          <td>{{ventas.id}}</td>
          <td>{{ventas.idpersona.dni}} - {{ventas.idpersona.nombre}} {{ventas.idpersona.apellido}}</td>
          <td>{{ventas.idinventario.idProducto.nombre}}</td>
          <td>{{ventas.idinventario.cantidad}}</td>
          <td>{{ventas.idinventario.precio}}</td>
          <td>{{formatearFecha(ventas.idinventario.fecha)}}</td>
          <td class="text-success">${{ventas.idinventario.precio * ventas.idinventario.cantidad}}</td>
          <td>
            <button type="button" class="btn btn-sm btn-ver me-2" data-bs-toggle="modal" data-bs-target="#verDataModal"
              (click)="verDatos(ventas,0)">
              <i class="fa-solid fa-id-card"></i>
            </button>
            <button type="button" class="btn btn-sm btn-editar me-2" data-bs-toggle="modal"
              data-bs-target="#ventaModalAgregar" (click)="verDatos(ventas,2)">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="btn btn-sm btn-eliminar" data-bs-toggle="modal" data-bs-target="#verDataModal"
              (click)="verDatos(ventas,1)">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
        <tr>
          <td class="text-right">
            <strong>Total:</strong>
          </td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td class="text-center text-success">
            <strong>${{calcularTotal()}}</strong>
          </td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<div class="modal fade" id="verDataModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header tcard-title">
        <div class="col-md-3">
          <button type="button" class="btn btn-sm btn-cancel" data-bs-dismiss="modal">Cerrar</button>
        </div>
        <div class="col-md text-center">
          <h4 class="modal-title" *ngIf="tipo==0">Ver datos</h4>
          <h4 class="modal-title" *ngIf="tipo==1">Eliminar</h4>
        </div>
        <div class="col-md-3 text-end">
          <button class="btn btn-crear btn-sm" data-bs-dismiss="modal" *ngIf="tipo==0">Ok</button>
          <button class="btn btn-eliminar btn-sm" *ngIf="tipo==1" (click)="eliminar(venta.id)">Eliminar</button>
        </div>
      </div>
      <div class="modal-body">
        <mdb-tabs>
          <mdb-tab title="Eliminar" *ngIf="tipo==1">
            <span class="text-center">¿Seguro de eliminar este registro de venta?</span>
            <table class="table table-striped table-bordered table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <td>{{venta.id}}</td>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th>Cliente</th>
                  <td>{{persona.dni}} - {{persona.nombre}} {{persona.apellido}}</td>
                </tr>
                <tr>
                  <th>Producto</th>
                  <td>{{producto.marca}} - {{producto.nombre}}</td>
                </tr>
                <tr>
                  <th>Cantidad</th>
                  <td>{{inventario.cantidad}}</td>
                </tr>
                <tr>
                  <th>Precio</th>
                  <td>{{inventario.precio}}</td>
                </tr>
                <tr>
                  <th>Fecha</th>
                  <td>{{formatearFecha(inventario.fecha)}}</td>
                </tr>
              </tbody>
            </table>
          </mdb-tab>
          <mdb-tab title="Datos Cliente" *ngIf="tipo==0">
            <table class="table table-striped table-responsive table-hover table-bordered">
              <thead>
                <tr>
                  <th>DNI</th>
                  <td>{{persona.dni}}</td>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th>Nombre</th>
                  <td>{{persona.nombre}}</td>
                </tr>
                <tr>
                  <th>Apellido</th>
                  <td>{{persona.apellido}}</td>
                </tr>
                <tr>
                  <th>Teléfono</th>
                  <td>{{persona.telefono}}</td>
                </tr>
                <tr>
                  <th>Correo</th>
                  <td>{{persona.correo}}</td>
                </tr>
                <tr>
                  <th>País</th>
                  <td>{{persona.pais}}</td>
                </tr>
              </tbody>
            </table>
          </mdb-tab>
          <mdb-tab title="Datos Producto" *ngIf="tipo==0">
            <table class="table table-striped table-responsive table-hover table-bordered">
              <thead>
                <tr>
                  <th>Nombre de producto</th>
                  <td>{{producto.nombre}}</td>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th>Marca</th>
                  <td>{{producto.marca}}</td>
                </tr>
                <tr>
                  <th>Proveedor</th>
                  <td>{{producto.idProveedor}}</td>
                </tr>
              </tbody>
            </table>
          </mdb-tab>
        </mdb-tabs>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="ventaModalAgregar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header tcard-title">
        <div class="col-md-3">
          <button type="button" class="btn btn-sm btn-cancel" data-bs-dismiss="modal">Cerrar</button>
        </div>
        <div class="col-md text-center">
          <h4 class="modal-title" *ngIf="tipo==3">Procesar venta</h4>
          <h4 calass="motal-title" *ngIf="tipo==2">Editar venta</h4>
        </div>
        <div class="col-md-3 text-end">
          <button class="btn btn-crear btn-sm" (click)="guardarVenta()" *ngIf="tipo==3">Procesar</button>
          <button class="btn btn-editar btn-sm" (click)="editarVenta()" *ngIf="tipo==2">Editar</button>
        </div>
      </div>
      <div class="modal-body">
        <mdb-tabs>
          <mdb-tab title="Editar venta" *ngIf="tipo==2">
            <form [formGroup]="ventaEditarForm" class="w-75 m-auto">
              <div class="row">
                <div class="col">
                  <table>
                    <tr>
                      <td>
                        <input type="number" class="form-control" formControlName="id" hidden>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <label>Cliente</label>
                      </td>
                      <td>
                        <select class="form-select" formControlName="idpersona">
                          <option value="">-- Seleccione --</option>
                          <option *ngFor="let persona of personas$ | async" [value]="persona.id">
                            {{persona.dni}} - {{persona.nombre}} {{persona.apellido}}
                          </option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <label>Producto</label>
                      </td>
                      <td>
                        <select class="form-select" formControlName="idproducto">
                          <option value="">-- Seleccione --</option>
                          <option *ngFor="let producto of productos$ | async" [value]="producto.id">
                            {{producto.nombre}}
                          </option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <label>Cantidad</label>
                      </td>
                      <td>
                        <input type="number" class="form-control" formControlName="cantidad">
                      </td>
                    </tr>
                  </table>
                </div>
                <div class="col">
                  <table>
                    <tr>
                      <td>
                        <label>Precio</label>
                      </td>
                      <td>
                        <input type="number" class="form-control" formControlName="precio" value="">
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <label>Fecha</label>
                      </td>
                      <td>
                        <input type="date" class="form-control" formControlName="fecha">
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
            </form>
          </mdb-tab>
          <mdb-tab title="Agregar venta" *ngIf="tipo==3">
            <form [formGroup]="ventaForm" class="w-75 m-auto">
              <div class="row">
                <div class="col">
                  <table>
                    <tr>
                      <td>
                        <label>Cliente</label>
                      </td>
                      <td>
                        <select class="form-select" formControlName="idpersona">
                          <option value="">-- Seleccione --</option>
                          <option *ngFor="let persona of personas$ | async" [value]="persona.id">
                            {{persona.dni}} - {{persona.nombre}} {{persona.apellido}}
                          </option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <label>Producto</label>
                      </td>
                      <td>
                        <select class="form-select" formControlName="idproducto">
                          <option value="">-- Seleccione --</option>
                          <option *ngFor="let producto of productos$ | async" [value]="producto.id">
                            {{producto.nombre}}
                          </option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <label>Cantidad</label>
                      </td>
                      <td>
                        <input type="number" class="form-control" formControlName="cantidad">
                      </td>
                    </tr>
                  </table>
                </div>
                <div class="col">
                  <table>
                    <tr>
                      <td>
                        <label>Precio</label>
                      </td>
                      <td>
                        <input type="number" class="form-control" formControlName="precio" value="">
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <label>Fecha</label>
                      </td>
                      <td>
                        <input type="date" class="form-control" formControlName="fecha">
                      </td>
                    </tr>
                  </table>
                  <button class="btn btn-sm btn-crear" (click)="agregar()" >Agregar</button>
                </div>
              </div>
            </form>
            <div *ngIf="mensaje" class="alert alert-primary mt-2" role="alert">
              {{mensaje}}
            </div>
          </mdb-tab>
          <mdb-tab title="Lista de ventas" *ngIf="tipo==3">
            <table class="table table-reponsive table-hover table-striped">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Precio</th>
                  <th>Total</th>
                  <th>Fecha de compra</th>
                  <th>Opciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let venta of listaVentas;let reg=index">
                  <td>
                    {{reg + 1}}
                  </td>
                  <td>
                    {{venta.idpersona}}
                  </td>
                  <td>
                    {{venta.idproducto}}
                  </td>
                  <td>
                    {{venta.cantidad}}
                  </td>
                  <td>
                    {{venta.precio}}
                  </td>
                  <td>{{venta.cantidad * venta.precio}}</td>
                  <td>{{venta.fecha}}</td>
                  <td>
                    <button type="button" class="btn btn-sm btn-eliminar">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div *ngIf="mensaje" class="alert alert-primary mt-2" role="alert">
              {{mensaje}}
            </div>
          </mdb-tab>
        </mdb-tabs>
      </div>
    </div>
  </div>
</div>
